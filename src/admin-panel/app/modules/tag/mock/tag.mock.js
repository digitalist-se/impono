/**
 * Copyright (C) 2015 Digimedia Sp. z.o.o. d/b/a Clearcode
 *
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

/* eslint-disable */
var tagsList = [{
        id: 0,
        name: 'Tag name 0_0',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 10,
        triggers: [
            {id: 0},
            {id: 1},
            {id: 2}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 1,
        name: 'Tag name 0_1',
        code: '<div>0_0<\/div>',
        no_script_uri: '',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 11,
        triggers: [
            {id: 2},
            {id: 1}
        ],
        document_write: false,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 2,
        name: 'Tag name 0_2',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 12,
        triggers: [
            {id: 0},
            {id: 2}
        ],
        document_write: false,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 3,
        name: 'Tag name 0_3',
        code: '<div>0_0<\/div>',
        no_script_uri: '',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 13,
        triggers: [
            {id: 3},
            {id: 4},
            {id: 5}
        ],
        document_write: false,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 4,
        name: 'Tag name 0_4',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 4,
        priority: 14,
        triggers: [],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 5,
        name: 'Tag name 0_5',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 16,
        triggers: [
            {id: 3},
            {id: 5}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 6,
        name: 'Tag name 0_6',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 15,
        triggers: [
            {id: 0},
            {id: 1},
            {id: 2}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 7,
        name: 'Tag name 0_7',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 17,
        triggers: [
            {id: 2},
            {id: 1}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 8,
        name: 'Tag name 0_8',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 18,
        triggers: [
            {id: 0},
            {id: 2}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 9,
        name: 'Tag name 0_9',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 19,
        triggers: [
            {id: 3},
            {id: 4},
            {id: 5}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 10,
        name: 'Tag name 0_10',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 20,
        triggers: [],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 11,
        name: 'Tag name 0_11',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 0,
        priority: 21,
        triggers: [
            {id: 3},
            {id: 5}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 12,
        name: 'Tag name 1_12',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 1,
        priority: 22,
        triggers: [
            {id: 12},
            {id: 13}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 13,
        name: 'Tag name 1_13',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 1,
        priority: 23,
        triggers: [
            {id: 12},
            {id: 13}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }, {
        id: 14,
        name: 'Tag name 2_14',
        code: '<div>0_0<\/div>',
        created_at: new Date('2015-04-14T09:50:28+0200'),
        updated_at: new Date('2015-04-14T09:50:28+0200'),
        container: 2,
        priority: 24,
        triggers: [
            {id: 14}
        ],
        document_write: true,
        disable_in_debug_mode: true,
        respect_visitors_privacy: false,
        is_synchronous: false
    }
];

var requestError = {
    'code': 400,
    'message': 'Validation Failed',
    'fields': {
        'name': [
            'This value should not be blank.'
        ]
    }
};

/* eslint-enable */

 /**
 * @name tag.tagMock
 *
 * @param {$httpBackend} $httpBackend
 * @param {ngTableParams} ngTableParams
 * @param $filter
 * @param {Mock} Mock
 * @param {$stateParams} $stateParams
 */
let tagMock = ($httpBackend, ngTableParams, $filter, Mock) => {
    let id = Mock.highestId('tags') + 1;

    $httpBackend.whenGET(/\/api\/containers\/(.*)\/tags\?*/).respond((method, url, data) => {
        let matches = url.match(/\/api\/containers\/(.*)/);

        matches = matches[1].split('/tags?');

        let criteria = {
            container: parseInt(matches[0])
        };

        let tags = Mock.query('tags', criteria);
        let tagsIndex = tags.length;

        while (tagsIndex--) {
            let triggersIndex = tags[tagsIndex].triggers.length;

            while (triggersIndex--) {
                let trigger = Mock.get('triggers', tags[tagsIndex].triggers[triggersIndex].id);
                tags[tagsIndex].triggers[triggersIndex] = trigger;
            }
        }

        var query = url.split('?')[1],
            requestParams = {},
            params;

        var vars = query.split('&');

        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            requestParams[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
        }

        // parse url params
        for (var key in requestParams) {
            if (key.indexOf('[') >= 0) {
                var value = requestParams[key], lastKey = '';
                params = key.split(/\[(.*)\]/);

                /* eslint-disable */
                angular.forEach(params.reverse(), (name) => {
                    if (name !== '') {
                        var v = value;
                        value = {};
                        value[lastKey = name] = !isNaN(v) ? parseFloat(v) : v;
                    }
                });
                /* eslint-enable */

                requestParams[lastKey] = angular.extend(requestParams[lastKey] || {}, value[lastKey]);
            } else {
                requestParams[key] = !isNaN(requestParams[key]) ? parseFloat(requestParams[key]) : requestParams[key];
            }
        }

        data = tags;
        var total = data.length;

        /* eslint-disable */
        params = new ngTableParams({
            page: (requestParams.offset / requestParams.limit) + 1,
            count: requestParams.limit
        });
        /* eslint-enable */

        data = data.slice((params.page() - 1) * params.count(), params.page() * params.count());

        return [200, {
            data: data,
            total: total
        }];
    });

    $httpBackend.whenPOST(/\/api\/containers\/(.*)\/tags/).respond(
        (method, url, data) => {
            var matches = url.match(/\/api\/containers\/(.*)/);
            matches = matches[1].split('/tags?');
            data = JSON.parse(data);

            /* eslint-disable */
            var newTag = {
                id: parseInt(id),
                name: data.name,
                code: data.code,
                created_at: new Date(),
                updated_at: new Date(),
                container: parseInt(matches[0]),
                priority: data.priority,
                triggers: [],
                respect_visitors_privacy: false,
                is_synchronous: false
            };
            /* eslint-enable */

            Mock.add('tags', newTag);
            id++;

            return [201, {data: newTag}];
        }
    );

    $httpBackend.whenGET(/\/api\/tags\/(.*)/).respond(
        (method, url) => {
            var matches = url.match(/\/api\/tags\/(.*)/);
            matches = matches[1].split('?');
            var tags = Mock.get('tags', matches[0]);
            var triggersIndex = tags.triggers.length;

            while (triggersIndex--) {
                tags.triggers[triggersIndex] = Mock.get('triggers', tags.triggers[triggersIndex].id);
            }

            return [200, {data: tags}];
        }
    );

    $httpBackend.whenPUT(/\/api\/tags\/(.*)/).respond(
        (method, url, data) => {
            data = JSON.parse(data);

            var matches = url.match(/\/api\/tags\/(.*)/);
            matches = matches[1].split('?');

            var tag = Mock.get('tags', parseInt(matches[0]));
            var triggersIndex = data.triggers.length;

            while (triggersIndex--) {
                data.triggers[triggersIndex] = Mock.get('triggers', data.triggers[triggersIndex]);
            }

            tag.name = data.name;
            tag.code = data.code;
            tag.triggers = data.triggers;
            tag.priority = data.priority;
            /* eslint-disable */
            tag.updated_at = new Date();
            /* eslint-enable */

            Mock.update('tags', tag);

            return [200, {data: tag}];
        }
    );

    $httpBackend.whenDELETE(/\api\/tags\/(.*)/).respond((method, url) => {
        var matches = url.match(/\api\/tags\/(.*)/);
        matches = matches[1].split('?');

        Mock.remove('tags', parseInt(matches[0]));

        return [204];
    });
};

module.exports = {tagMock, tagsList};
